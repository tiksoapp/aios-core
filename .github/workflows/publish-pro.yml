# GitHub Actions workflow for publishing @aios-fullstack/pro to npm
#
# This workflow publishes the AIOS Pro package to the public npm registry.
# Features are license-gated (activation required), not install-gated.
#
# @see Story PRO-6 - License Key & Feature Gating System

name: Publish AIOS Pro

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Publish as prerelease (beta/alpha)'
        required: false
        type: boolean
        default: false

  # Auto-trigger on pro version tags
  push:
    tags:
      - 'pro-v*'

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Quality Gates - Must pass before publish
  # ─────────────────────────────────────────────────────────────────────────────
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run typecheck || echo "TypeScript check skipped"

      - name: Run tests
        run: npm test -- tests/license/

      - name: Build verification
        run: npm run build || echo "Build skipped (no build step)"

  # ─────────────────────────────────────────────────────────────────────────────
  # Publish to npm
  # ─────────────────────────────────────────────────────────────────────────────
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: quality-gates
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          submodules: true

      - name: Setup Node.js with npm registry
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          registry-url: https://registry.npmjs.org

      - name: Update version from tag
        if: startsWith(github.ref, 'refs/tags/pro-v')
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION=$(echo "$TAG_NAME" | sed 's/^pro-v//')
          cd pro
          npm version $VERSION --no-git-tag-version

      - name: Update version from input
        if: github.event.inputs.version
        run: |
          cd pro
          npm version ${{ github.event.inputs.version }} --no-git-tag-version

      - name: Publish package
        run: |
          cd pro
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create release notes
        if: startsWith(github.ref, 'refs/tags/pro-v')
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const version = '${{ github.ref_name }}'.replace('pro-v', '');
            const body = `
            ## AIOS Pro ${version}

            ### Installation

            \`\`\`bash
            npm install @aios-fullstack/pro
            aios pro activate --key PRO-XXXX-XXXX-XXXX-XXXX
            \`\`\`

            ### Features
            - License key validation and feature gating
            - 30-day offline operation with grace period
            - Machine-specific encrypted cache
            - Graceful degradation to core features

            See [Install Guide](https://github.com/SynkraAI/aios-core/blob/main/docs/guides/pro/install-gate-setup.md) for detailed setup instructions.
            `;

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ github.ref_name }}',
              name: `AIOS Pro ${version}`,
              body: body,
              prerelease: ${{ github.event.inputs.prerelease || false }}
            });

  # ─────────────────────────────────────────────────────────────────────────────
  # Verify Installation (Post-publish check)
  # ─────────────────────────────────────────────────────────────────────────────
  verify:
    name: Verify Installation
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: Verify package is accessible
        run: npm view @aios-fullstack/pro

      - name: Test installation
        run: |
          mkdir test-install && cd test-install
          npm init -y
          npm install @aios-fullstack/pro
          echo "✅ Package installed successfully"
