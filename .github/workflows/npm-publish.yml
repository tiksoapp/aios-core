name: Publish to NPM
# Story 6.1 - Added concurrency

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish_mode:
        description: 'Publishing mode'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - stable
          - beta
      packages:
        description: 'Packages to publish (comma-separated, or "all")'
        required: false
        default: 'all'

concurrency:
  group: npm-publish-${{ github.ref }}
  cancel-in-progress: false  # Never cancel publishing in progress

env:
  NODE_VERSION: '20'
  NPM_REGISTRY: 'https://registry.npmjs.org/'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run security audit
        run: npm audit --audit-level=moderate

  build:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.package-version.outputs.version }}
      packages: ${{ steps.detect-packages.outputs.packages }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get package version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Detect packages to publish
        id: detect-packages
        run: |
          if [ "${{ github.event.inputs.packages }}" = "all" ] || [ -z "${{ github.event.inputs.packages }}" ]; then
            PACKAGES="core,memory,security,performance,telemetry,workspace"
          else
            PACKAGES="${{ github.event.inputs.packages }}"
          fi
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: Build all packages
        run: |
          # Create lib directories for packages that need them
          for pkg in .aios-core memory security performance telemetry; do
            if [ -d "$pkg" ]; then
              mkdir -p "$pkg/lib"
              echo '{"built": true}' > "$pkg/lib/build.json"
            fi
          done
          
          echo "âœ… Build preparation complete"

      - name: Create distribution archive
        run: |
          mkdir -p dist
          tar -czf dist/@synkra/aios-core-${{ steps.package-version.outputs.version }}.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=dist \
            --exclude=tests \
            --exclude='*.log' \
            .

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            .aios-core/lib/
            memory/lib/
            security/lib/
            performance/lib/
            telemetry/lib/
          retention-days: 7

  publish:
    needs: [test, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Set publishing tag
        id: publish-tag
        run: |
          if [ "${{ github.event.inputs.publish_mode }}" = "stable" ] || [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.publish_mode }}" = "beta" ]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          else
            echo "tag=preview" >> $GITHUB_OUTPUT
          fi

      - name: Check if aios-core should be published
        id: should-publish
        run: |
          PKG_NAME="aios-core"
          VERSION="${{ needs.build.outputs.version }}"

          # Check if package exists in registry
          if npm view "${PKG_NAME}@${VERSION}" version > /dev/null 2>&1; then
            echo "Version ${VERSION} already exists for ${PKG_NAME}"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Package ${PKG_NAME}@${VERSION} not found in registry"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish aios-core to NPM
        if: steps.should-publish.outputs.should_publish == 'true'
        run: |
          # Create npmrc for authentication
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc

          # Publish with appropriate tag
          npm publish --tag ${{ steps.publish-tag.outputs.tag }} --access public

          echo "âœ… Published aios-core@${{ needs.build.outputs.version }} with tag ${{ steps.publish-tag.outputs.tag }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify publication
        if: steps.should-publish.outputs.should_publish == 'true'
        run: |
          sleep 10  # Wait for npm registry to update

          if npm view "aios-core@${{ needs.build.outputs.version }}" version > /dev/null 2>&1; then
            echo "âœ… Verified: aios-core@${{ needs.build.outputs.version }} is available on NPM"
          else
            echo "âŒ Verification failed: aios-core@${{ needs.build.outputs.version }} not found"
            exit 1
          fi

  notify:
    needs: [build, publish]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify completion
        run: |
          if [ "${{ needs.publish.result }}" = "success" ]; then
            echo "ðŸŽ‰ Successfully published aios-core to NPM:"
            echo "   Version: ${{ needs.build.outputs.version }}"
            echo "   Package: aios-core"
            echo "   Registry: ${{ env.NPM_REGISTRY }}"
            echo "   URL: https://www.npmjs.com/package/aios-core"
          else
            echo "âŒ Publishing failed"
            exit 1
          fi

  create-release-notes:
    needs: [build, publish]
    if: github.event_name == 'release' && needs.publish.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate release notes
        run: |
          cat > release-notes.md << 'EOF'
          # AIOS-Core v${{ needs.build.outputs.version }}

          ## ðŸ“¦ NPM Package

          | Package | NPM Link | Description |
          |---------|----------|-------------|
          | aios-core | [npmjs.com](https://www.npmjs.com/package/aios-core) | AI-Orchestrated System for Full Stack Development |

          ## ðŸš€ Installation

          ```bash
          # Global installation (recommended)
          npm install -g aios-core

          # Or as project dependency
          npm install aios-core
          ```

          ## ðŸ“‹ What's New

          * âœ… Complete Meta-Agent MVP and Framework Distribution
          * ðŸ”’ Security hardening with penetration testing
          * âš¡ Performance optimization framework
          * ðŸ“Š Privacy-conscious telemetry system
          * ðŸ“¦ Modular NPM package distribution

          ## ðŸ”— Links

          * [GitHub Repository](https://github.com/SynkraAI/aios-core)
          * [Documentation](https://github.com/SynkraAI/aios-core#readme)
          * [Issues](https://github.com/SynkraAI/aios-core/issues)
          EOF

      - name: Update release with notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release-notes.md', 'utf8');

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: releaseNotes
            });