storyId: NOG-12
storyTitle: State Persistence Hardening (Atomic Writes + Session Cleanup)
epic: NOGIC — Code Intelligence Integration
reviewer: Quinn (QA)
reviewDate: '2026-02-21'
agentModel: Claude Opus 4.6
verdict: PASS

summary: |
  Implementation is correct, well-tested, and within scope. All 3 ACs fully met.
  atomicWriteSync utility created with proper Windows/POSIX handling.
  All 4 writeFileSync points converted to atomic writes transparently.
  Session cleanup wired into first-prompt with configurable TTL.
  97/97 tests passing. Journey snapshot shows no code-caused regressions.

ac_traceability:
  AC1_atomic_write_utility:
    status: PASS
    evidence:
      - '.aios-core/core/synapse/utils/atomic-write.js — write-to-tmp + rename pattern'
      - 'Windows: unlinkSync before rename (NTFS cannot overwrite via rename)'
      - 'Cleanup of tmp file on failure'
      - 'console.error with [atomic-write] prefix on errors'
      - 'tests/synapse/atomic-write.test.js — 10 tests including crash simulation'

  AC2_apply_to_4_points:
    status: PASS
    evidence:
      - 'session-manager.js:231 — updateSession() uses atomicWriteSync'
      - 'context-detector.js:195 — updateSessionState() uses atomicWriteSync'
      - 'unified-activation-pipeline.js:714 — _writeSynapseSession() uses atomicWriteSync'
      - 'unified-activation-pipeline.js:760 — _persistUapMetrics() uses atomicWriteSync'
      - 'All 97 existing tests pass unchanged (transparent to callers)'

  AC3_wire_session_cleanup:
    status: PASS
    evidence:
      - 'hook-runtime.js:61 — cleanStaleSessions called when prompt_count === 0'
      - 'hook-runtime.js:63 — TTL read from core-config.yaml via getStaleSessionTTL()'
      - 'core-config.yaml — synapse.session.staleTTLHours: 168 added'
      - 'Fire-and-forget (try/catch around cleanup, never blocks hook)'
      - 'hook-runtime.test.js — 2 new tests verify wiring + skip behavior'
      - 'DEBUG=1 logging when sessions cleaned'

test_coverage:
  suites:
    - name: atomic-write.test.js
      tests: 10
      status: PASS
      coverage: 'new file, overwrite, no orphan, crash sim, dir creation, cleanup on failure, empty data, large data, encoding'
    - name: hook-runtime.test.js
      tests: 6
      status: PASS
      coverage: 'null cwd, no .synapse, resolve runtime, cleanup on first prompt, skip on existing, buildHookOutput'
    - name: session-manager.test.js
      tests: 34
      status: PASS
      coverage: 'existing tests unchanged'
    - name: engine.test.js
      tests: 47
      status: PASS
      coverage: 'existing tests unchanged'
  total: 97
  regressions: 0

performance:
  journey_snapshot: NOG-12
  vs_previous: NOG-11
  assessment: 'All deltas are I/O measurement noise (gitConfig/permissionMode variance on Windows). No code-caused regressions. Atomic rename is <0.1ms — unmeasurable impact.'

security:
  - check: Path traversal
    status: OK
    notes: 'File paths derived from internal session UUIDs and config paths'
  - check: Tmp file race condition
    status: ACCEPTED
    notes: 'Brief window between unlink+rename on Windows (~nanoseconds), standard Node.js pattern'
  - check: Config injection
    status: OK
    notes: 'TTL validated as typeof number && > 0'
  - check: Error messages
    status: OK
    notes: 'Internal paths only, no user data exposed'

issues: []
# All 3 original CONCERNS resolved:
# 1. createSession() now uses atomicWriteSync (session-manager.js:136)
# 2. Redundant dir creation removed from context-detector.js
# 3. Story Testing section corrected (hook-runtime.test.js listed)
# Test mock updated to match atomicWriteSync tmp-path pattern
