# Quality Gate Configuration for Story 3.0 - Security Hardening
# Version: 1.0
# Created: 2025-12-01

story_id: "3.0"
story_name: "Core Module Security Hardening"
priority: critical

# Acceptance Criteria Gates
acceptance_criteria:
  # ReDoS Prevention
  AC3.0.1:
    name: "Pattern validation before RegExp construction"
    type: code_review
    verification: "isSafePattern() function exists and is called before RegExp creation"

  AC3.0.2:
    name: "Native validation implemented"
    type: code_review
    verification: "Native ReDoS pattern detection implemented (no external package required)"

  AC3.0.3:
    name: "Try/catch wrapper around RegExp compilation"
    type: code_review
    verification: "RegExp construction wrapped in try/catch in isSafePattern()"

  AC3.0.4:
    name: "Safe failure mode for rejected patterns"
    type: code_review
    verification: "Invalid patterns return error message, not throw"

  # Path Traversal Prevention
  AC3.0.5:
    name: "SessionId validation with strict hex pattern"
    type: code_review
    verification: "/^[a-f0-9]{16}$/i pattern enforced in isValidSessionId()"

  AC3.0.6:
    name: "Invalid sessionId rejection with clear error"
    type: code_review
    verification: "getSessionPath() throws descriptive error for invalid sessionId"

  AC3.0.7:
    name: "path.join() used instead of string concatenation"
    type: code_review
    verification: "path.join() used in getSessionPath()"

  # Error Handling
  AC3.0.8:
    name: "Try/catch in loadSession for fs.readJson"
    type: code_review
    verification: "loadSession() has try/catch wrapper"

  AC3.0.9:
    name: "Clear error logging with sessionPath context"
    type: code_review
    verification: "Error logging includes sessionPath in message"

  AC3.0.10:
    name: "Sensible failure return value"
    type: code_review
    verification: "loadSession() returns null on failure"

  # Variable Initialization
  AC3.0.11:
    name: "this.currentSession properly initialized"
    type: code_review
    verification: "this.currentSession = null in constructor"

  AC3.0.12:
    name: "No uninitialized variable access in completeSession"
    type: code_review
    verification: "this.currentSession set in startSession()"

  # Regression Prevention
  AC3.0.13:
    name: "All CORE tests pass"
    type: automated_test
    command: "npm test -- --passWithNoTests"
    pass_threshold: 90

  AC3.0.14:
    name: "CodeRabbit scan shows no MEDIUM+ security findings"
    type: security_scan
    tool: coderabbit
    severity_threshold: MEDIUM

# Smoke Tests
smoke_tests:
  SEC-01:
    name: "ReDoS Prevention"
    description: "Malicious regex rejected"
    priority: P0
    pass_criteria: "Pattern validation works"
    test_type: unit

  SEC-02:
    name: "Path Traversal Block"
    description: "../ in sessionId rejected"
    priority: P0
    pass_criteria: "Throws error"
    test_type: unit

  SEC-03:
    name: "Valid Session Loads"
    description: "Normal sessions still work"
    priority: P0
    pass_criteria: "No regression"
    test_type: integration

  SEC-04:
    name: "Error Handling"
    description: "Invalid session path handled"
    priority: P1
    pass_criteria: "Returns null, no crash"
    test_type: unit

  SEC-05:
    name: "CodeRabbit Clean"
    description: "No MEDIUM+ findings"
    priority: P1
    pass_criteria: "Scan passes"
    test_type: security_scan

# Rollback Triggers
rollback_triggers:
  - condition: "Any P0 test fails"
    action: "Fix immediately"
  - condition: "CORE tests regress"
    action: "Rollback and investigate"

# Files Modified
files_modified:
  - ".aios-core/core/elicitation/elicitation-engine.js"
  - ".aios-core/core/elicitation/session-manager.js"

# Definition of Done
definition_of_done:
  - "All 4 security vulnerabilities addressed"
  - "No MEDIUM+ CodeRabbit findings"
  - "CORE-01 to CORE-07 tests pass"
  - "SEC-01 to SEC-05 smoke tests pass"
  - "Story checkboxes updated"
  - "QA Review passed"
  - "PR created and approved"
