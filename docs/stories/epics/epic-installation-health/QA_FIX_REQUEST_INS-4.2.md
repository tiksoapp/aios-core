# QA Fix Request — Story INS-4.2

**From:** @qa (Quinn)
**To:** @dev (Dex)
**Date:** 2026-02-23
**Priority:** MEDIUM
**Story:** INS-4.2 Settings.json Boundary Generator

---

## Fix 1: Path Traversal Validation (C1 — MEDIUM)

**Problem:** `expandProtectedPaths` and `expandExceptionPaths` accept paths without validation. A path like `../../etc/passwd` in `core-config.yaml` would be processed without error, potentially creating deny/allow rules for paths outside the project.

**Risk:** LOW (input comes from framework-owned `core-config.yaml`, not user input), but defense-in-depth demands validation.

**File:** `.aios-core/infrastructure/scripts/generate-settings-json.js`

**Fix:** Add a `validateBoundaryPath` function and call it during `readBoundaryConfig`. Insert after line 11 (after `TOOLS` constant):

```javascript
/**
 * Validate that a boundary path does not escape the project root via traversal.
 * Rejects paths containing '..' segments or absolute paths.
 */
function validateBoundaryPath(p) {
  const segments = p.replace(/\\/g, '/').split('/');
  if (segments.some(function(s) { return s === '..'; })) {
    throw new Error('Path traversal detected in boundary config: ' + p);
  }
  if (path.isAbsolute(p)) {
    throw new Error('Absolute path not allowed in boundary config: ' + p);
  }
}
```

Then in `readBoundaryConfig`, after building the `protected` and `exceptions` arrays (before the `return` on line 32), add validation:

```javascript
  const result = {
    frameworkProtection: boundary.frameworkProtection !== false,
    protected: Array.isArray(boundary.protected) ? boundary.protected : [],
    exceptions: Array.isArray(boundary.exceptions) ? boundary.exceptions : [],
  };

  // Validate all paths against traversal
  for (const p of result.protected) { validateBoundaryPath(p); }
  for (const p of result.exceptions) { validateBoundaryPath(p); }

  return result;
```

**Test to add** in `generate-settings-json.test.js`, inside the `readBoundaryConfig` describe block:

```javascript
test('rejects path traversal in protected paths', () => {
  const tmpDir = createTempProject({
    frameworkProtection: true,
    protected: ['../../etc/passwd'],
    exceptions: [],
  });

  try {
    expect(() => readBoundaryConfig(tmpDir)).toThrow('Path traversal detected');
  } finally {
    cleanupTempProject(tmpDir);
  }
});

test('rejects absolute paths in boundary config', () => {
  const tmpDir = createTempProject({
    frameworkProtection: true,
    protected: ['/etc/passwd'],
    exceptions: [],
  });

  try {
    expect(() => readBoundaryConfig(tmpDir)).toThrow('Absolute path not allowed');
  } finally {
    cleanupTempProject(tmpDir);
  }
});
```

**Export:** Add `validateBoundaryPath` to `module.exports` for testability.

---

## Fix 2: Replace `yaml` with `js-yaml` (C3 — LOW)

**Problem:** The script uses `require('yaml')` but the root `package.json` declares `js-yaml` (not `yaml`). The `yaml` package resolves only because `pro/package.json` has it as a workspace dependency. If `pro/` is absent or the script is used standalone, it breaks.

**Evidence:**
- Root `package.json` dependencies: `"js-yaml": "^4.1.0"` (line 85)
- All other `.aios-core/` scripts use `js-yaml`: `ide-sync/index.js`, `repository-detector.js`, `unified-activation-pipeline.js`, etc.
- Only `generate-settings-json.js` uses `yaml` — inconsistent with project convention

**File:** `.aios-core/infrastructure/scripts/generate-settings-json.js`

**Fix:** Replace line 7:

```diff
- const yaml = require('yaml');
+ const yaml = require('js-yaml');
```

And update line 24 to use `js-yaml` API:

```diff
-   const config = yaml.parse(content);
+   const config = yaml.load(content);
```

(`js-yaml` uses `.load()` instead of `.parse()`)

**No other changes needed** — the returned object structure is identical.

**Test impact:** None — tests use `createTempProject` which writes YAML directly via string concatenation, not via the yaml library. The `readBoundaryConfig` integration test against the real project will validate the fix.

---

## Verification Steps

After applying both fixes:

1. `node .aios-core/infrastructure/scripts/generate-settings-json.js .` — should output "already up to date"
2. `npx jest packages/installer/tests/unit/generate-settings-json/ --verbose` — all tests pass (10 existing + 2 new)
3. Verify idempotency: run generator twice, `git diff .claude/settings.json` shows no changes

---

*Generated by @qa (Quinn) — QA Fix Request for Story INS-4.2*
